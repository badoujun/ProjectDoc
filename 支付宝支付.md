# 1.使用流程

![](image\582f41c938e76135c55c16f7259a9924-1570696969794.png)

# 2.创建应用

## 2.1 进入页面

https://open.alipay.com/platform/manageHome.htm

## 2.2开发者接入

![1570699534968](image\1570699534968.png)

```shell
`个人开发者无法直接对接支付宝，必须有公司的资质`
1.选择网页&移动应用
2.移动应用分为安卓和IOS
```

## 2.3创建应用


![1570700421376](image\1570700421376.png)

```shell
'创建应用时的应用状态为“开发中”，无法在线上正式调用接口。'
1.应用名称:应用名称和应用图标会在授权、分享的场景中露出，请准确填写相关信息。
2.应用图标:代表应用的应用图标，不可上传黄赌毒图片，符合蚂蚁开放审核标准。

'注意:应用名称和应用图标会在应用申请上线时进行审核，所以在配置时，建议先了解相关审核规则。'
```

## 2.4添加应用功能





```shell
'此处请注意开发者和使用者的区别：'

开发者：应用（功能或者服务）的开发人员（或者企业）；
使用者：购买和使用应用（功能或者服务）的人员（或者企业）。
当开发者自己使用自己开发的应用时，开发者和使用者的两个身份是重合的。
```



## 2.5配置应用环境





# 3.App支付

> https://docs.open.alipay.com/204

## 3.1场景介绍

>适用于商家在 App 应用中集成支付宝支付功能。
>商家APP调用支付宝提供的 SDK，SDK 再调用支付宝APP内的支付模块。
>
>1.如果用户已安装支付宝 APP，商家 APP 会跳转到支付宝中完成支付，支付完后跳回到商家APP内，最后展示支付结果。
>
>2.如果用户没有安装支付宝 APP，商家 APP 内会调起支付宝网页支付收银台，用户登录支付宝账户，支付完后展示支付结果。
>目前支持手机系统有：iOS（苹果）、Android（安卓）。

## 3.2准入条件

- 申请前必须拥有经过实名认证的支付宝账户；
- 企业或个体工商户可申请；
- 需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；
- 网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；
- 网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；
- 如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。

## 3.3快速接入

1. 获得APPID

> 要在您的应用中接入支付宝 App 支付能力，您需要登录支付宝开放平台（[open.alipay.com](https://open.alipay.com/)），在开发者中心中创建您的应用，应用审核通过后会生成应用唯一标识（**APPID**），并且可以申请开通开放产品使用权限。

2. 添加功能并签约

> 应用创建完成后，系统会自动跳转到应用详情页面。开发者可以点击 **添加功能** 来[添加App支付功能](https://docs.open.alipay.com/common/105366)。添加功能后开发者需要在开放平台里进行[签约](https://b.alipay.com/signing/productDetail.htm?productId=I1011000290000001002)，第三方应用开发者可以代替商户签约。

3. 配置秘钥

> 为了保证交易双方（商户和支付宝）的身份和数据安全，开发者在调用接口前，需要配置双方密钥，对交易数据进行双方校验。RSA 密钥包含应用私钥（APP_PRIVATE_KEY）、应用公钥（APP_PUBLIC_KEY）。生成密钥后，开发者需要在开放平台开发者中心进行密钥配置，配置完成后可以获取支付宝公钥（ALIPAY_PUBLIC_KEY）
>
> **说明：**支付宝开放平台 SDK 封装了签名和验签过程，只需配置账号及密钥参数，建议开发者使用。

​                                      进入应用------鼠标滚动最下面----------找到开发设置

![1570714373290](image\1570714373290.png)

​                                                                              所需配置内容表格

| 字段名称        | 字段描述                                                     |
| :-------------- | :----------------------------------------------------------- |
| RSA(SHA256)密钥 | 开发者要保证接口中使用的私钥与此处的公钥匹配，否则无法调用接口。可参考密钥的[生成与配置](https://docs.open.alipay.com/291/105971)，且接口参数 sign_type=RSA2。 |
| RSA(SHA1)密钥   | 同上，且接口参数 sign_type=RSA。                             |
| 应用网关        | 选填字段，用于接收支付宝异步通知，例如口碑开店中，需要配置此网关来接收[开发者门店被动通知](https://docs.open.alipay.com/205/105251#s1)；开发者视实际需要填写。 |
| 授权回调地址    | 第三方授权或用户信息授权后回调地址。授权链接中配置的 redirect_uri 的值必须与此值保持一致(如：https://www.alipay.com) 。当填入该地址时，系统会自动进行安全检测 |

![1570714867914](image\1570714867914.png)

## 3.4生成秘钥

### 3.4.1生成工具

> 支付宝为技术开发人员提供一键生成工具，便于开发者生成一对 RSA 密钥、公钥证书申请CSR文件（在线申请应用公钥证书需要）。
>
> 下载地址：https://docs.open.alipay.com/291/105971

```shell
1. 应用公钥（public key）需提供给支付宝账号管理者上传到支付宝开放平台； '解密'
2. 应用私钥（private key）由开发者自己保存，需填写到代码中供签名时使用。'加密'
`加密的过程为系统使用公钥（public key）进行加密，并将密文发送到解密者，解密者用私钥（private key）解密将密文解码为明文。`
'【注意】
- 开发者要保证接口中使用的私钥与此处的公钥匹配，否则无法调用接口。
- 密钥和应用（APPID）一一对应，即开发者需要为名下的每个应用分别设置密钥，且不同应用的密钥不能混用。
```

### 3.4.2打开工具

> 开发者根据开发语言选择密钥格式和密钥长度，新建应用请务必使用 2048 位（目前已使用 1024 位密钥长度的应用仍然可以正常调用接口，详情请见开放平台接口签名方式升级公告）。点击 生成密钥 后，工具会自动生成商户应用公钥（public key）和应用私钥（private key）

![1570716345890](image\1570716345890.png)

```shell
# 公钥
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwnezd5MqJ1yrGcw1GlDt1YoYOk97Zar1aF/wBV1hxeBxTwS+UEgxH89bXP4s303bZUnSf8VAls6MgohV1NSEqUoe617+yhZ6ybNfchQafdalXjzzipuPBYntp0j1scY11/7q8SlrZoVFLZchOkwY/yZtvFqg9ZwmntlyXUgLiwN5dhyaHLPS35cDU120Knghgjed9YeaMuTVJYDQ586t+hlE6wkrt4kRpm/AXGZvPVBQ+X3oSyOWDPLv67lxUnYVBtMZrWH9Ut5zTIhNl+E19jcqgfP23N5oYHL+fqglvkFZSBbxbScBKPc4DXBM+DhhMHnfIWvGeVRXBtdPiWamLwIDAQAB

# 私钥
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDCd7N3kyonXKsZzDUaUO3Vihg6T3tlqvVoX/AFXWHF4HFPBL5QSDEfz1tc/izfTdtlSdJ/xUCWzoyCiFXU1ISpSh7rXv7KFnrJs19yFBp91qVePPOKm48Fie2nSPWxxjXX/urxKWtmhUUtlyE6TBj/Jm28WqD1nCae2XJdSAuLA3l2HJocs9LflwNTXbQqeCGCN531h5oy5NUlgNDnzq36GUTrCSu3iRGmb8BcZm89UFD5fehLI5YM8u/ruXFSdhUG0xmtYf1S3nNMiE2X4TX2NyqB8/bc3mhgcv5+qCW+QVlIFvFtJwEo9zgNcEz4OGEwed8ha8Z5VFcG10+JZqYvAgMBAAECggEAMAIDASsIhg0fhE/gcC24eTYNQx/qE7A/w1Oj2n8yKvp8nohKP2GDFxpGsM9i3oHG/ttZpwdYKaK2F2d24QLR+UT+GxcpiVRBXdf1YSFLZPN/gaNEcFx002Y4kEq3tPp8wmUBNSYHiJiv+lBL+KtepGalQpGRGPFCq4Z88EBf8SIsuE0qMNKH7Zneyg9jY4wjRxMvrZUvZvn16V8n5y8El7RKUTwhW7SlCvHRlH3DuStBEE70rV0k9MJzvYXlP7v7ozfgVW8nU7TcSj01srKQpCClvOZ4xCIjYrCIcInSaq+xj49Ugsendrjnb0RzUulmzS49dGHx/AFF7XWEek4wKQKBgQD24D0BUDFKYols+UwL6cAwWswT+d7H7cT0ls26RB+qjznl0Cd27iYslUWz+nAZh99NelQynSo4BYRntiziEX3PH6aNDN3ZEPeVQuYDCgWwR1S2lq/q4gGZ/dzOSY6Z9DljdD7jPITr+KH6OwHHUqMjEqPKYRQhKZL+SE9+U/eVCwKBgQDJp5zhIDvS/y84hc0Gn0CjtoQJcNi7zIAND+y+Nxd++8gAKKgJsgQGMOhHnnbALsGw/J9/BZ7SuZueoXexU5b8zDQanhZpvQR44TbSkedueccxIypCt8ZMNlC1Ipk8+5IzpNXrD6vXeST+p2kuK/C0OdOSK5WOJcHKb8XD43nh7QKBgG2nGdGcgdgtPicF784WzANuQNjakiYxKNsOpGAIZBxIs4ms0+qSSqhgwO343ZOpcvihzgYRIrBxWucJ1pOu+zdlMn/R6DPCwoUsiqds6yvp8umKsqZcLiPsywdhSpJ9FIRlHI2n0s5Qx/kx/k8/GDC61b9NMTitk5mYGp7cwsoTAoGBAJrUXeighi5wDkKYwR3XgprwlRpmkZJH5v2gf4Zg6GJwUVSF4tdm3h4eyQnMSqMugzswDApMN3DWX/0BPtRhOOmqpErXnJ/dKCTjzuMIcahqSh2ZQWZukguMHJWnFf8zrUKHylOr+aX8dwIrad+wjyThzWdKnY7BwLR881x/OOLVAoGAK+G16UW/HtefFi1uYfrGKPQ6rGdN3M+ChKsoYvBXo8yGfa4ekCvVyUN2FhtYGJd/Z1CBb/o4LWXcWhPH35vqBuE5AVfXJF2qyBUrCUoExaAXCFV9lr2l9lacCAk2MNbayIEfrXwjdsB3PXAh5dH8pbR9t/n2gTwkFgMM6gDFEjg=
```

### 3.4.3配置公钥

1. 点击开发设置

![1570716618461](image\1570716618461.png)

2. 复制工具生成的秘钥

![1570716574369](image\1570716574369.png)

3. 成功页面

![1570716719239](image\1570716719239.png)

### 3.4.4私钥使用

```shell
# 生成的私钥需妥善保管，避免遗失，不要泄露。应用私钥需填写到代码中供签名时使用。
1. 签名的过程即生成签名方（通常为商户）将传送的消息用私钥加密的过程；
2. 验签则是指验签方（通常为开放平台的服务端）使用公钥对消息进行验证的过程。
# 以 JAVA 语言为例
`签名的过程大致为：`
1. 签名方首先对参数放入一个字符串数组 signFields，把参数和值放入一个对象或 map 中，使用 JSONObject 把这个对象转化成 json 对象。
2. 然后构建签名原文，在构建签名原文时，我们需把参数按照字典（比如a,b,c）顺序排序，具体排序方法直接调用 JAVA 的 Arrays.sort 方法。 
3. 然后使用 RSA 的私钥对签名原文进行签名。
`验签方（通常为开放平台的服务端）：`
1. 和生产签名方一样先生成签名原文
2. 然后使用 RAS 的公钥生成签名方传入的签名，把签名原文对生成签名方传入的签名进行验证，验证结果为 true 则说明验证成功，否则未通过。
# SDK
'支付宝开放平台 SDK 封装了签名和验签过程，只需配置账号及密钥参数即可，强烈建议使用。'
- SDK下载地址：https://docs.open.alipay.com/54/103419

```

> 注意：由于实例化SDK客户端时需要指定应用的私钥信息，请务必注意不要将私钥信息配置在源码中（比如配置为常量或储存在配置文件的某个字段中等），因为私钥的保密等级往往比源码高得多，将会增加私钥泄露的风险。推荐将私钥信息储存在专用的私钥文件中，将私钥文件通过安全的流程分发到服务器的安全储存区域上，仅供自己的应用运行时读取。
>
> SDK已经对加签验签逻辑做了封装，使用SDK可直接调用API。
> 确定接口对应的类
> 例如接口名：alipay.offline.material.image.upload
> 在SDK中对应的类为：每个单词首字母大写，并去掉分隔符（“.”），末尾加上Request（或Response）
> 如上接口名对应的类为：
> AlipayOfflineMaterialImageUploadRequest（请求类）
> AlipayOfflineMaterialImageUploadResponse（响应类）



### 3.4.5公钥证书（推荐）

> 比较推荐的验证加密方式，比公钥更安全

1. 生成证书

![1570718159555](image\1570718159555.png)

![1570717723187](image\1570717723187.png)

![1570717833388](image\1570717833388.png)

2. 上传证书

![1570718245363](image\1570718245363.png)

3. 上传成功

![1570718292965](image\1570718292965.png)

# 4.SDK使用

```shell
1. 服务端SDK
Java、PHP、.Net、Python、NodeJS SDK，支持所有 Open API。
2. App支付SDK
iOS、Android应用嵌入APP支付SDK，用户支付时唤起支付宝完成支付。
3. 分享到支付宝SDK
iOS、Android应用嵌入分享到支付宝SDK，营销活动通过用户分享给支付宝好友。
```

## 4.1服务端POM

> 其实就是一堆jar包，maven地址
>
> https://mvnrepository.com/artifact/com.alipay.sdk/alipay-sdk-java
>
> 推荐使用4.4.5以上的版本

```xml
<!--支付宝SDK -->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.7.12.ALL</version>
</dependency>
```

## 4.2SDK包说明

| SDK包                             | 说明              |
| --------------------------------- | ----------------- |
| alipay-sdk-java*.jar              | 支付宝SDK编译文件 |
| alipay-sdk-java*-source.jar       | 支付宝SDK源码文件 |
| commons-logging-1.1.1.jar         | SDK依赖的日志     |
| commons-logging-1.1.1-sources.jar | SDK依赖的日志源码 |
| bcprov-jdk15on-1.62.jar           | SDK依赖的证书工具 |



## 4.3普通公钥集成

### 4.3.1普通公钥调用

```java
//实例化客户端
AlipayClient alipayClient = new DefaultAlipayClient("https://openapi.alipay.com/gateway.do", APP_ID, APP_PRIVATE_KEY, "json", CHARSET, ALIPAY_PUBLIC_KEY, "RSA2");
//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.open.public.template.message.industry.modify 
AlipayOpenPublicTemplateMessageIndustryModifyRequest request = new AlipayOpenPublicTemplateMessageIndustryModifyRequest();
//SDK已经封装掉了公共参数，这里只需要传入业务参数
//此次只是参数展示，未进行字符串转义，实际情况下请转义
request.setBizContent("  {" +
"    \"primary_industry_name\":\"IT科技/IT软件与服务\"," +
"    \"primary_industry_code\":\"10001/20102\"," +
"    \"secondary_industry_code\":\"10001/20102\"," +
"    \"secondary_industry_name\":\"IT科技/IT软件与服务\"" +
" }");
AlipayOpenPublicTemplateMessageIndustryModifyResponse response = alipayClient.execute(request); 
//调用成功，则处理业务逻辑
if(response.isSuccess()){
  //.....
}
```

### 4.3.2图片上传接口调用

```java
AlipayClient alipayClient = new DefaultAlipayClient("https://openapi.alipay.com/gateway.do", APP_ID, APP_PRIVATE_KEY, "json", CHARSET, ALIPAY_PUBLIC_KEY, "RSA2");
// 实例化具体API对应的request类,类名称和接口名称对应，当前调用接口名称：alipay.offline.material.image.upload 
AlipayOfflineMaterialImageUploadRequest request = new AlipayOfflineMaterialImageUploadRequest();
request.setImageName("test");
//Windows请填写绝对路径，不支持相对路径；Linux支持相对路径
FileItem item = new FileItem("C:/Downloads/ooopic_963991_7eea1f5426105f9e6069/16365_1271139700.jpg");
request.setImageType("JPG");
request.setImageContent(item);
//执行API请求
AlipayOfflineMaterialImageUploadResponse response = alipayClient.execute(request);
//调用成功，则处理业务逻辑
if(response.isSuccess()){
     //获取图片访问地址
  String imageUrl = response.getImageUrl();
  //.....
}
```

### 4.3.3用户授权接口调用

```java
AlipayClient alipayClient = new DefaultAlipayClient("https://openapi.alipay.com/gateway.do", APP_ID, APP_PRIVATE_KEY, "json", CHARSET, ALIPAY_PUBLIC_KEY, "RSA2");
//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.user.userinfo.share
AlipayUserUserinfoShareRequest request = new AlipayUserUserinfoShareRequest();
//授权类接口执行API调用时需要带上accessToken
AlipayUserUserinfoShareResponse response= alipayClient.execute(request,"accessToken"); 
//业务处理
//...
```

### 4.3.4应用授权接口调用

```java
AlipayClient alipayClient = new DefaultAlipayClient("https://openapi.alipay.com/gateway.do", APP_ID, APP_PRIVATE_KEY, "json", CHARSET, ALIPAY_PUBLIC_KEY, "RSA2");
//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.open.public.template.message.industry.modify 
AlipayOpenPublicTemplateMessageIndustryModifyRequest request = new AlipayOpenPublicTemplateMessageIndustryModifyRequest();
//SDK已经封装掉了公共参数，这里只需要传入业务参数
//此次只是参数展示，未进行字符串转义，实际情况下请转义
request.setBizContent("  { " +
"    \"primary_industry_name\":\"IT科技/IT软件与服务\"," +
"    \"primary_industry_code\":\"10001/20102\"," + 
"    \"secondary_industry_code\":\"10001/20102\"," +
"    \"secondary_industry_name\":\"IT科技/IT软件与服务\"" +
"  }");
//ISV代理商户调用需要传入app_auth_token
request.putOtherTextParam("app_auth_token", "201511BBaaa6464f271f49e482f2e9fe63ca5F05");
AlipayOpenPublicTemplateMessageIndustryModifyResponse response = alipayClient.execute(request); 
//调用成功，则处理业务逻辑
if(response.isSuccess()){
  //.....
}
```

## 4.4公钥证书集成

> java版SDK 4.4.2.ALL中并没有对APP支付场景添加证书支持，若业务使用到该场景，请下载4.4.5.ALL及以上版本的SDK。

### 4.4.1公钥证书调用

```java
//构造client（默认）
CertAlipayRequest certAlipayRequest = new CertAlipayRequest();
//设置网关地址（默认）
certAlipayRequest.setServerUrl("https://openapi.alipay.com/gateway.do");
//设置应用Id（传入）
certAlipayRequest.setAppId(app_id);
//设置应用私钥（传入）
certAlipayRequest.setPrivateKey(privateKey);
//设置请求格式，固定值json（默认）
certAlipayRequest.setFormat("json");
//设置字符集
certAlipayRequest.setCharset(charset);
//设置签名类型
certAlipayRequest.setSignType(sign_type);
//设置应用公钥证书路径
certAlipayRequest.setCertPath(app_cert_path);
//设置支付宝公钥证书路径
certAlipayRequest.setAlipayPublicCertPath(alipay_cert_path);
//设置支付宝根证书路径
certAlipayRequest.setRootCertPath(alipay_root_cert_path);
//构造client
AlipayClient alipayClient = new DefaultAlipayClient(certAlipayRequest);
//构造API请求
AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();
//发送请求
AlipayTradeQueryResponse response = alipayClient.certificateExecute(request);
```

### 4.4.2图片上传接口调用

```java
//构造client
CertAlipayRequest certAlipayRequest = new CertAlipayRequest();
DefaultAlipayClient alipayClient = new DefaultAlipayClient(certAlipayRequest);
// 实例化具体API对应的request类,类名称和接口名称对应，当前调用接口名称：alipay.offline.material.image.upload 
AlipayOfflineMaterialImageUploadRequest request = new AlipayOfflineMaterialImageUploadRequest();
request.setImageName("test");
//Windows请填写绝对路径，不支持相对路径；Linux支持相对路径
FileItem item = new FileItem("C:/Downloads/ooopic_963991_7eea1f5426105f9e6069/16365_1271139700.jpg");
request.setImageType("JPG");
request.setImageContent(item);
//执行API请求
AlipayOfflineMaterialImageUploadResponse response = alipayClient.execute(request);
//调用成功，则处理业务逻辑
if(response.isSuccess()){
     //获取图片访问地址
  String imageUrl = response.getImageUrl();
  //.....
}
```

### 4.4.3用户授权接口调用

```java
//构造client
CertAlipayRequest certAlipayRequest = new CertAlipayRequest();
DefaultAlipayClient alipayClient = new DefaultAlipayClient(certAlipayRequest);
//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.user.userinfo.share
AlipayUserUserinfoShareRequest request = new AlipayUserUserinfoShareRequest();
//授权类接口执行API调用时需要带上accessToken
AlipayUserUserinfoShareResponse response = alipayClient.certificateExecute(request, "access_token");
```

### 4.4.4应用授权接口调用

```java
//构造client
CertAlipayRequest certAlipayRequest = new CertAlipayRequest();
AlipayClient alipayClient = new DefaultAlipayClient(certAlipayRequest);
//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.open.public.template.message.industry.modify 
AlipayOpenPublicTemplateMessageIndustryModifyRequest request = new AlipayOpenPublicTemplateMessageIndustryModifyRequest();
//SDK已经封装掉了公共参数，这里只需要传入业务参数
//此次只是参数展示，未进行字符串转义，实际情况下请转义
request.setBizContent("  { " +
"    \"primary_industry_name\":\"IT科技/IT软件与服务\"," +
"    \"primary_industry_code\":\"10001/20102\"," + 
"    \"secondary_industry_code\":\"10001/20102\"," +
"    \"secondary_industry_name\":\"IT科技/IT软件与服务\"" +
"  }");
//ISV代理商户调用需要传入app_auth_token
request.putOtherTextParam("app_auth_token", "201511BBaaa6464f271f49e482f2e9fe63ca5F05");
//发送应用授权请求
AlipayTradeQueryResponse response = alipayClient.certificateExecute(request);
```

# 5.当面付Demo

> 下载Demo：https://docs.open.alipay.com/54/104506/
>
> 下载完成后是eclipse工程，所以需要用IDEA导入

## 5.1IDEA导入Demo

### 5.1.1导入文件

![1570759897727](image\1570759897727.png)

![1570759948996](image\1570759948996.png)

![img](image\Center)

​                                                   接下来一直next到结束

### 5.1.2JDK配置

![1570760204252](image\1570760204252.png)

### 5.1.3路径设置

> 设置变异后的class文件输出位置

![1570760319483](image\1570760319483.png)

### 5.1.4依赖管理

![1570760459292](image\1570760459292.png)

### 5.1.5创建WEB

![1570760548228](image\1570760548228.png)

![img](image\20170506234144849)

![1570760621698](image\1570760621698.png)

### 5.1.6打包配置

![img](image\20170506234303993)

![img](image\20170506234402602)

![1570760883099](image\1570760883099.png)

### 5.1.7配置tomcat

![1570760923290](image\1570760923290.png)

![1570760961706](image\1570760961706.png)

### 5.1.8启动Demo

![1570761039904](image\1570761039904.png)

## 5.2集成SDK

```shell
1、拷贝java目录下的Main.java（和DemoHbRunner.java,如果需要集成交易保障接口）至系统商源代码目录
2、将lib目录下所有jar文件添加至系统商lib目录，如果没有alipay-trade-sdk.jar(此jar包集成了当面付交易逻辑和交易保障接口)，则将TradePaySDK编译为该jar包
3、拷贝resources目录下的配置文件至系统商classpath根目录
4、在系统商项目中运行Main方法，确认集成无误
5、系统商使用main方法中的调用样例进行商户端系统开发
```

![1570761566160](image\1570761566160.png)

## 5.3生成Jar包

> 目的：将lib目录下所有jar文件添加至系统商lib目录，如果没有alipay-trade-sdk.jar(此jar包集成了当面付交易逻辑和交易保障接口)，则将TradePaySDK编译为该jar包

### 5.3.1配置JDK

![1570762701060](image\1570762701060.png)

### 5.3.2配置打包方式

> 配置打包的方式，如果是jar包选择要打包的目录

![1570762830775](image\1570762830775.png)

![1570762894575](image\1570762894575.png)

![1570763272062](image\1570763272062.png)

### 5.3.3开始打包

![1570763047681](image\1570763047681.png)

![1570763090223](image\1570763090223.png)

![1570763318127](image\1570763318127.png)

### 5.3.4存储到仓库

> 接下来可以创建三坐标存储到本地maven仓库

## 5.4配置文件

```shell
# 需要配置的参数
1. pid: '此处请填写你的PID，只要登录就默认是商户了，就有PID，在账户中心直接就可以看到'
2. appid: '此处请填写你当面付的APPID'
3. private_key: '直接复制支付宝秘钥生成器的私钥'
4. public_key: '复制支付宝秘钥生成器的公钥'
```

![](image\1570764726153.png)

![1570773368839](image\1570773368839.png)

![1570773891248](image\1570773891248.png)

![1570778480495](image\1570778480495.png)

```properties

# 支付宝网关名、partnerId和appId
open_api_domain = https://openapi.alipay.com/gateway.do
mcloud_api_domain = http://mcloudmonitor.com/gateway.do
pid = 2088922419201860
appid = 2019101068313104

# RSA私钥、公钥和支付宝公钥
private_key = MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCStNqHpA6hwdlL26LIgKYnt9/wOp2rTSqbSThzDzGr1U/uBTU76P2DC2US+4zcuMWYTCZ0O4tSGOxOmnVidWYJPdlKDh6KTHyp0PvFcDY6mfVNiTkM7eadZdT+56G8j9x2NPLpqSYEkt3ddXIzhGFCXaZpygZCFQeArcG6ROzKly9QVH0wJKxsm17hYiFO7IpK/puE4cU9JNWU8uB2NgrRH0vrwan3Mea3kF4zBwMqtdSPKvLydhfTMQwm5g0sLOsQE0NnkxFA99shqNQYlb4yKeF+vcYpuKpSGwoRrGa9GkFUI5YL+eqq54w7VD0gXBJuIw6gpHWt+DgQumc3JRm7AgMBAAECggEAdDO4HFRAGrP2r/VKXNI5yaAFSrzDAlpe8xzuD4TrbRXK99c8MTX9B31RE9YX3wSjzlwS4WIAmoiPNDt32wLuTUemAthoLFclL0UPB3Y4HfawrDeS7sDJN8bfDQDfxQGWODL8bUPDjz/daHqMeG3Us8KF+6k/h7wscyouFqJdhKE5qmBRu2fWaTwsbN6Ij9eLhRfFIM9TkV/6G7RbsC+D8XD41NI5BRjEpniWVT53Rw//onrkPJ6SnrgtCwjqOpZe0zxT2ZvksZTo4UYeIcpisE3/RsOSAp1lQ5OEcGjh9jqDJAly+GRkkIK0jnJgjcfUiSAocIOA0+5tdNa4/+snAQKBgQD8+Te7bXTy8cS3MavFVjjfyUPlgcvNb2b5gy8U19DVtDRUaGPtV/byeTCMQxdQ7+FXPOXUDnqBClG/hex9xdm9BwulA9T4Ljc1tVUg8kDav6oXXqunRcelPRTJ5Ag4MUMuHSz8KJzvNMGDrSJQpY7TZ8E3ZNDIRx8SWSNVdTq2+wKBgQCUdiv0oGJeP+Sacd19Tq3UhVzNWHgxqGvjkSfrg4MaLn/cWdEquoDOgr11Io9wPL9AJbSSUoGOGUDtPE+cTaJiaTNMLhFzWBVFN2LXwKs1hAhZFEAechVWO2Du4EcNKeLYUZTK3B3sBWfYb9xqHd5Y81zK/XjKfb6ULdRevySsQQKBgFAsI4+Q9vlvyepNIaUe2FOEE7KO2io3XilBfBBc/WBdBiCiHNlBgZAC/HHXaXJLM91T/XqhRA3VWWcbaIHLzF/t9bDMcBhffTvWRi502Dz7dUqGxFv073rcytPZIwm8AxCASpt3u5TL4XB71F4+ue8h+Mg3eTuf3qcP/PS+fGc1AoGAfSdhxseuJWYXgVucLJa3VAFZSoLaUIJ68UzdKl2jl967SzcsbajsDSuKK8UGxsdvMtSWdQO40+HWKig9tLZ9vhiRdhcf/uyygbc/TELQEj1MDExWAVSLSDamcLoBK8ezxEiB9sG5N88WzA8A8TRczP/bqgQkYA/BKYm5DmZ0tAECgYBjqnRotiR1YyUQsdKA1u3WWZ5bUQry+EaQK3yJKR1rGIX1owH8t09x9vIe+l2QM4vYXydEtO2pxFHdg93xq2q7Gz1ODHAbgsgsks+PMFq11njUAOAgxJ6OmMHdssUuMZOmm5UVEvWGe5CdRoS8iuUDbJqP9ihMhKjdmXR+2Y5jKw==

public_key = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAkrTah6QOocHZS9uiyICmJ7ff8Dqdq00qm0k4cw8xq9VP7gU1O+j9gwtlEvuM3LjFmEwmdDuLUhjsTpp1YnVmCT3ZSg4eikx8qdD7xXA2Opn1TYk5DO3mnWXU/uehvI/cdjTy6akmBJLd3XVyM4RhQl2macoGQhUHgK3BukTsypcvUFR9MCSsbJte4WIhTuyKSv6bhOHFPSTVlPLgdjYK0R9L68Gp9zHmt5BeMwcDKrXUjyry8nYX0zEMJuYNLCzrEBNDZ5MRQPfbIajUGJW+Minhfr3GKbiqUhsKEaxmvRpBVCOWC/nqqueMO1Q9IFwSbiMOoKR1rfg4ELpnNyUZuwIDAQAB

#SHA1withRsa对应支付宝公钥
#alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB

#SHA256withRsa对应支付宝公钥
alipay_public_key = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjrEVFMOSiNJXaRNKicQuQdsREraftDA9Tua3WNZwcpeXeh8Wrt+V9JilLqSa7N7sVqwpvv8zWChgXhX/A96hEg97Oxe6GKUmzaZRNh0cZZ88vpkn5tlgL4mH/dhSr3Ip00kvM4rHq9PwuT4k7z1DpZAf1eghK8Q5BgxL88d0X07m9X96Ijd0yMkXArzD7jg+noqfbztEKoH3kPMRJC2w4ByVdweWUT2PwrlATpZZtYLmtDvUKG/sOkNAIKEMg3Rut1oKWpjyYanzDgS7Cg3awr1KPTl9rHCazk15aNYowmYtVabKwbGVToCAGK+qQ1gT3ELhkGnf3+h53fukNqRH+wIDAQAB

# 签名类型: RSA->SHA1withRsa,RSA2->SHA256withRsa
sign_type = RSA2
# 当面付最大查询次数和查询间隔（毫秒）
max_query_retry = 5
query_duration = 5000

# 当面付最大撤销次数和撤销间隔（毫秒）
max_cancel_retry = 3
cancel_duration = 2000

# 交易保障线程第一次调度延迟和调度间隔（秒）
heartbeat_delay = 5
heartbeat_duration = 900
```

# 6.沙箱环境

```shell
'在app的开发过程中可能你的支付功能还未开通，那么我们就可以利用沙箱环境来辅助我们开发，其实这就是支付宝提供给我们的一个测试的环境。'

#为什么使用沙箱环境？
创建一个应用（企业用户才可以，个人开发者不行）
我们可以拿到应用的appid。在真正上线的时候需要提交这些信息进行审核的。
微信支付和支付宝支付都是要求企业认证才可以完成的。个人开发者是不可以的。
由于个人开发者不可以认证，所以我们选择用沙箱环境
`就相当于我自己创建的一个应用`
```

## 6.1获取沙箱APPID

> pid就是商户uid

![1570780956265](image\1570780956265.png)

![1570781179880](image\1570781179880.png)

## 6.2配置应用秘钥

![1570783712570](image\1570783712570.png)

![1570783735162](image\1570783735162.png)

## 6.3配置文件

```properties

# 支付宝网关名、partnerId和appId
open_api_domain = https://openapi.alipaydev.com/gateway.do
mcloud_api_domain = http://mcloudmonitor.com/gateway.do
pid = 2088922419201860
appid = 2016101100664241

# RSA私钥、公钥和支付宝公钥
private_key = MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCRGSIifxTKtH1BOvYTCcfb80M5pkmSGXnUdH8t/JJ8RrIFxKErvo6uHpiGUQYATW9bS5LcQLqGikTIO3JoBvo7GMfUjD+xz+98NebR7ete493U3hTisUaKJxTDJxYtPXyNuvujR8A/EqSMsAdK7wGnLUtF+uXb5XwEBm9DJGwVyVznEE0qgo0lPuov1KSkJCwrHUX5CH1V/ZmYWOV2WPpgy59YMfNzjv1dcbBOyogRAlZqyTUsRAeGW/UJRQO7AV1ErTThVXB1ElR6uLbBkwXDc8Xd99i6oUFXG/BlXPsEGHvIMVp6AgvfBFXjbAzlmP/pMH+5a/0uP+kRaD6UoIIpAgMBAAECggEAEyGON6Ar3KI5lZ0xjscOW/jSF0rOjn3fa1zE3ApeQhaMKGiJm5vvchPEpokOUoHjOdVYEsRSE6Utdn0oE4FAAwS8bFDloQs6l1UADxPgoc1HlWaGuHEJTPPkL+r6aJKf1owd26R9O5O4sHgRLhcfT6yQLTTsk7bJSDqU9vRZb/G+B2wer+CzUBDefFdhHeC6DszAIJztYlK7dKJwohikxaFBPS9yjW+qlfYL7np+jN3EZZN8p6FsMgrbNo/F8jgOZ7T/1E4wK8jHA+yLbxOqRSIgTK3xx+CQQCACGfW33BUH5cEq/TzyhtLSddy/Dj5JFZs5SNZCwGL8o7gjN8xuBQKBgQDqp78mwkamcEMagU6w2pCBfWqxnMwJ6Bmjtm4QDHibaSsiPUG+Kk+wk5gaSlNldmbhKNifTGtlRgFJGoV8o7mNqEvYLXKggtonS5ujxnTy72gwY0GPWhdYQE+nNZqb/Kq4291rLAQPYVMS3droDTwQ8B/nB2DfoDgAElLeOjDdmwKBgQCeS+7vmUiTWIPPDagvxdk7HslVqRW6wwDLF2VM6OfICxcs1bYPR3aU8Ha5/2qSo7kEZrWXxFnPJqMZoETNCeOvgMlN+CyCFt5bFXhmr6gXfE9x2EOtyRvnllxZ9Lg2+vWZIH9nbUd+8SKpmNUrCY/hfwZ/Rj9FDpY0Od5VL6L9iwKBgFByWfIrwJTm/9piYlv3UntSR/XET59F1yRtMqaF4ANHtuXyIkvTraZXs1mwCY9LXFHs8vcJ9/esXFx3nzPv3XlXLUlbq2Sj965pGV64dveiZBHStXMz67Txt10X332CzfS6S9qmKG4ta5GYRagwgVs9N3K48Nk50HkVzxsoz//pAoGAUyRi7Sm/etTE9l2f9ued/3VeHkXfCeceZY12QX0bMHDSzVO6ei/40qWyVmMXIMophWxE+N/CpBERHYaWXHNTSX0FPpSZHALS61hNkvG0AhHi0FLcyUyWAX9yJjVpBEev86uj/zjgkoYoxJdnb2FoVvIXAYZt+OF+dxPl+Sw6GZ0CgYEA3zKGGxPwIEM1qiV10ihY2YBcr2JU3Ov57c+iYVq4KqDYiX8gZDPxONOIFV5vHwTrztH/WKzJasTR9sUdaoThg0PNqbNRVQ9w3LS0WbADq7uqSxT4aAY5Z9c/M1sOVIj8VPh+zb/PgBJtZ2xc2W/EgW+0gVM2bWIry8bcnTxQpAk=

public_key = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAkRkiIn8UyrR9QTr2EwnH2/NDOaZJkhl51HR/LfySfEayBcShK76Orh6YhlEGAE1vW0uS3EC6hopEyDtyaAb6OxjH1Iw/sc/vfDXm0e3rXuPd1N4U4rFGiicUwycWLT18jbr7o0fAPxKkjLAHSu8Bpy1LRfrl2+V8BAZvQyRsFclc5xBNKoKNJT7qL9SkpCQsKx1F+Qh9Vf2ZmFjldlj6YMufWDHzc479XXGwTsqIEQJWask1LEQHhlv1CUUDuwFdRK004VVwdRJUeri2wZMFw3PF3ffYuqFBVxvwZVz7BBh7yDFaegIL3wRV42wM5Zj/6TB/uWv9Lj/pEWg+lKCCKQIDAQAB

#SHA1withRsa对应支付宝公钥
#alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB

#SHA256withRsa对应支付宝公钥
alipay_public_key = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0yPRAY+EvTDNMAn/BeWFzPfXdk+H076V/X/3+qgJ4s6tNqnLBX3T6mp+6Ls/aMnBiPJFxIysCOereulOt9+B34eqMT4GgdMjVI581oN7w4nQ+ujyTQ9wi+QVQWdWB1WdQOl7ePcKuQP+9jqjHCFkKAS/P1ZZx6tjM8mDooJ8gdCf2NTe9C3ihobD2Sd+NUPMfJOSjdZE/zgByB1B4gqcdORYS3mkkfdR79euLY8gRYQUGXOAx5b/4R43RJT2CMhBckQeajdkts8iDqXshzetGQNfbJ4VrezwG1NBMoRI0B3xW31V/dM8y2OsLiCQrjLExDEuDtDTK74paJiDKHAXsQIDAQAB

# 签名类型: RSA->SHA1withRsa,RSA2->SHA256withRsa
sign_type = RSA2
# 当面付最大查询次数和查询间隔（毫秒）
max_query_retry = 5
query_duration = 5000

# 当面付最大撤销次数和撤销间隔（毫秒）
max_cancel_retry = 3
cancel_duration = 2000

# 交易保障线程第一次调度延迟和调度间隔（秒）
heartbeat_delay = 5
heartbeat_duration = 900

```

## 6.4当面付Demo测试

```java
package com.alipay.demo.trade;

import com.alipay.api.AlipayResponse;
import com.alipay.api.domain.TradeFundBill;
import com.alipay.api.response.AlipayTradePrecreateResponse;
import com.alipay.api.response.AlipayTradeQueryResponse;
import com.alipay.api.response.MonitorHeartbeatSynResponse;
import com.alipay.demo.trade.config.Configs;
import com.alipay.demo.trade.model.ExtendParams;
import com.alipay.demo.trade.model.GoodsDetail;
import com.alipay.demo.trade.model.builder.*;
import com.alipay.demo.trade.model.hb.*;
import com.alipay.demo.trade.model.result.AlipayF2FPayResult;
import com.alipay.demo.trade.model.result.AlipayF2FPrecreateResult;
import com.alipay.demo.trade.model.result.AlipayF2FQueryResult;
import com.alipay.demo.trade.model.result.AlipayF2FRefundResult;
import com.alipay.demo.trade.service.AlipayMonitorService;
import com.alipay.demo.trade.service.AlipayTradeService;
import com.alipay.demo.trade.service.impl.AlipayMonitorServiceImpl;
import com.alipay.demo.trade.service.impl.AlipayTradeServiceImpl;
import com.alipay.demo.trade.service.impl.AlipayTradeWithHBServiceImpl;
import com.alipay.demo.trade.utils.Utils;
import com.alipay.demo.trade.utils.ZxingUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.*;

/**
 * Created by liuyangkly on 15/8/9.
 * 简单main函数，用于测试当面付api
 * sdk和demo的意见和问题反馈请联系：liuyang.kly@alipay.com
 */
public class Main {
    private static Log                  log = LogFactory.getLog(Main.class);

    // 支付宝当面付2.0服务
    private static AlipayTradeService   tradeService;

    // 支付宝当面付2.0服务（集成了交易保障接口逻辑）
    private static AlipayTradeService   tradeWithHBService;

    // 支付宝交易保障接口服务，供测试接口api使用，请先阅读readme.txt
    private static AlipayMonitorService monitorService;

    static {
        /** 一定要在创建AlipayTradeService之前调用Configs.init()设置默认参数
         *  Configs会读取classpath下的zfbinfo.properties文件配置信息，如果找不到该文件则确认该文件是否在               classpath目录
         */
        Configs.init("zfbinfo.properties");

        /** 使用Configs提供的默认参数
         *  AlipayTradeService可以使用单例或者为静态成员对象，不需要反复new
         */
        tradeService = new AlipayTradeServiceImpl.ClientBuilder().build();

        // 支付宝当面付2.0服务（集成了交易保障接口逻辑）
        tradeWithHBService = new AlipayTradeWithHBServiceImpl.ClientBuilder().build();

        /** 如果需要在程序中覆盖Configs提供的默认参数, 可以使用ClientBuilder类的setXXX方法修改默认参数 否则             使用代码中的默认设置 */
        monitorService = new AlipayMonitorServiceImpl.ClientBuilder()
            .setGatewayUrl("http://mcloudmonitor.com/gateway.do").setCharset("GBK")
            .setFormat("json").build();
    }

    // 简单打印应答
    private void dumpResponse(AlipayResponse response) {
        if (response != null) {
            log.info(String.format("code:%s, msg:%s", response.getCode(), response.getMsg()));
            if (StringUtils.isNotEmpty(response.getSubCode())) {
                log.info(String.format("subCode:%s, subMsg:%s", response.getSubCode(),
                    response.getSubMsg()));
            }
            log.info("body:" + response.getBody());
        }
    }

    public static void main(String[] args) {
        Main main = new Main();
        // 测试当面付2.0生成支付二维码
        main.test_trade_precreate();
    }

 
    // 测试当面付2.0生成支付二维码
    public void test_trade_precreate() {
        // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线，
        // 需保证商户系统端不能重复，建议通过数据库sequence生成，
        String outTradeNo = "tradeprecreate" + System.currentTimeMillis()
                            + (long) (Math.random() * 10000000L);

        // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费”
        String subject = "xxx品牌xxx门店当面付扫码消费";

        // (必填) 订单总金额，单位为元，不能超过1亿元
        // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:
        //【订单总金额】    =【打折金额】+【不可打折金额】
        String totalAmount = "0.01";

        // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段
        // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】
        String undiscountableAmount = "0";

        // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号)
        // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID
        String sellerId = "";

        // 订单描述，可以对交易或商品进行一个详细地描述，比如填写"购买商品2件共15.00元"
        String body = "购买商品3件共20.00元";

        // 商户操作员编号，添加此参数可以为商户操作员做销售统计
        String operatorId = "test_operator_id";

        // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持
        String storeId = "test_store_id";

        // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付            宝技术支持
        ExtendParams extendParams = new ExtendParams();
        extendParams.setSysServiceProviderId("2088100200300400500");

        // 支付超时，定义为120分钟
        String timeoutExpress = "120m";

        // 商品明细列表，需填写购买商品详细信息，
        List<GoodsDetail> goodsDetailList = new ArrayList<GoodsDetail>();
        // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品            类别，详见GoodsDetail
        GoodsDetail goods1 = GoodsDetail.newInstance("goods_id001", "xxx小面包", 1000, 1);
        // 创建好一个商品后添加至商品明细列表
        goodsDetailList.add(goods1);

        // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件
        GoodsDetail goods2 = GoodsDetail.newInstance("goods_id002", "xxx牙刷", 500, 2);
        goodsDetailList.add(goods2);

        // 创建扫码支付请求builder，设置请求参数
        AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder()
            .setSubject(subject)
            .setTotalAmount(totalAmount)
            .setOutTradeNo(outTradeNo)
            .setUndiscountableAmount(undiscountableAmount)
            .setSellerId(sellerId)
            .setBody(body)
            .setOperatorId(operatorId)
            .setStoreId(storeId)
            .setExtendParams(extendParams)
            .setTimeoutExpress(timeoutExpress)
            //.setNotifyUrl("http://www.test-notify-url.com")//支付宝服务器主动通知商户                               服务器里指定的页面http路径,根据需要设置
            .setGoodsDetailList(goodsDetailList);

        AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder);
        switch (result.getTradeStatus()) {
            case SUCCESS:
                log.info("支付宝预下单成功: )");

                AlipayTradePrecreateResponse response = result.getResponse();
                dumpResponse(response);

                // 需要修改为运行机器上的路径
                String filePath = String.format("/Users/sudo/Desktop/qr-%s.png",
                    response.getOutTradeNo());
                log.info("filePath:" + filePath);
                // ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath);
                break;

            case FAILED:
                log.error("支付宝预下单失败!!!");
                break;

            case UNKNOWN:
                log.error("系统异常，预下单状态未知!!!");
                break;

            default:
                log.error("不支持的交易状态，交易返回异常!!!");
                break;
        }
    }
}

```

## 6.5配置成功

![1570783951740](image\1570783951740.png)

```shell
# 拿到二维码code，使用二维码生成工具生成，实质就是一个地址
"qr_code":"https://qr.alipay.com/bax02509hma2se0ziles00dd" 
`二维码就是RQCODE`
```

# 7.API使用

## 7.1API介绍

```shell
`API在线测试网址`
'https://openhome.alipay.com/platform/demoManage.htm#/alipay.trade.query'
`API文档查看网址`
'https://docs.open.alipay.com/204/105303/'
# 实际使用
- 实际使用很简单
1.property配置文件的加载
2.request请求的构建
3.调用需要的API

#接口转换成请求类
- 如alipay.trade.create转换成AlipayTradeCreateRequest供后端使用
```

| 常用API                      | 作用                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| AlipayTradeCreateRequest     | 创建支付订单，生成支付二维码                                 |
| AlipayTradeWapPayRequest     | 该接口需要手机才能使用，直接吊起支付宝APP                    |
| AlipayTradeCloseRequest      | 用户在一定时间内未进行支付，可调用该接口直接将未付款的交易进行关闭。 |
| AlipayTradePayRequest        | 根据订单二维码向支付宝发起支付                               |
| AlipayTradePageRefundRequest | 卖家可以通过退款页面接口将支付款退还给买家，支付宝将在收到退款请求并且验证成功之后，按照退款规则将支付款按原路退到买家帐号上。 |
| AlipayTradeQueryRequest      | 商户可以通过该接口主动查询订单状态，完成下一步的业务逻辑。   |

## 7.2同步通知

```shell
#理解
`同步通知是用来告诉用户支付成功了；异步通知等于说是用来处理业务上的信息，比如说对于数据库的一些操作等等。由于这些操作可能比较耗时，对于用户来说只需要知道自己支付成功了，所以这些操作用异步来做，并不影响主流程的业务。`
#支付宝sdk对商户的请求支付数据处理完成后，会将结果同步反馈给商户app端。
   同步通知返回的是用户系统的通知页面
#用好查询类接口，对系统业务层会省很多人力
    需要调用查询接口的情况： 当商户后台、网络、服务器等出现异常，商户系统最终未接收到支付通知； 调用支付接口后，返回系统错误或未知交易状态情况； 调用alipay.trade.pay，返回INPROCESS的状态； 调用alipay.trade.cancel之前，需确认支付状态；
#配置参数return_url
`买家付款成功后,如果接口中指定有return_url ,买家付完款后会跳到 return_url所在的页面,这个页面可以展示给客户看,这个页面只有付款成功才会跳转.`
public static String return_url = "http://www.theBestApe.com/pages/front/pay/aliPayResTb";
```

## 7.3异步通知

```shell
#异步通知作用：解耦，分布式事物，保证数据的完整性。使用第三方服务就相当于分布式    
    异步通知用来修改数据库订单状态，成功必须返回”success”,否则支付宝服务器会不断重发通知，直到超过24小时22分钟。一般情况下，25小时以内完成8次通知（通知的间隔频率一般是：4m,10m,10m,1h,2h,6h,15h）  
#配置参数notify_url
    跳转页面，买家支付成功后跳转的页面，仅当买家支付成功后跳转一次。也就是说这页面是返回给用户看的。
`服务器异步通知页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问`
 public static String notify_url = "http://www.theBestApe.com/pages/front/pay/aliPayResYb";
```

## 7.4完整Demo

### 7.4.1配置文件

```java
package com.thebestape.xyz.alipay.config;

import java.io.FileWriter;
import java.io.IOException;

/**
 * @auther zhangHongLu
 * @date 2019/10/14 0014 11:01
 */
public class AlipayConfig {
    // 应用ID,您的APPID，收款账号既是您的APPID对应支付宝账号
    public static String app_id = "20160926******";

    // 商户私钥，您的PKCS8格式RSA2私钥
    public static String merchant_private_key = "私钥";

    // 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。
    public static String alipay_public_key = "公钥";

    // 服务器异步通知页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问
    public static String notify_url = "http://yan.eicp.net:26003/MyCSDN/pay/pay_notify";

    // 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问
    public static String return_url = "http://yan.eicp.net:26003/MyCSDN/pay/pay_return";


    // 签名方式
    public static String sign_type = "RSA2";

    // 字符编码格式
    public static String charset = "utf-8";

    // 支付宝网关
    public static String gatewayUrl = "https://openapi.alipaydev.com/gateway.do";

    // 支付宝网关
    public static String log_path = "C:\\";


//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑

    /**
     *      * 写日志，方便测试（看网站需求，也可以改成把记录存入数据库）
     *      * @param sWord 要写入日志里的文本内容
     *      
     */
    public static void logResult(String sWord) {
        FileWriter writer = null;
        try {
            writer = new FileWriter(log_path + "alipay_log_" + System.currentTimeMillis() + ".txt");
            writer.write(sWord);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            if (writer != null) {
                try {
                    writer.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

```

### 7.4.2工具类

```java
import com.alipay.api.*;
import com.alipay.api.domain.AlipayTradeWapPayModel;
import com.alipay.api.request.*;
import com.it.exception.AlipayRuntimeException;

public class AlipayUtil {

    public static String pay(String out_trade_no, String total_amount, String subject, String body) {
        //获得初始化的AlipayClient
        AlipayClient alipayClient = new DefaultAlipayClient(AlipayConfig.gatewayUrl, AlipayConfig.app_id,  AlipayConfig.merchant_private_key, "json", AlipayConfig.charset, AlipayConfig.alipay_public_key, AlipayConfig.sign_type);
        //设置请求参数
        AlipayTradePagePayRequest alipayRequest = new AlipayTradePagePayRequest();
        alipayRequest.setReturnUrl(AlipayConfig.return_url);
        alipayRequest.setNotifyUrl(AlipayConfig.notify_url);

        //设置订单信息
        AlipayTradeWapPayModel model = new AlipayTradeWapPayModel();
        model.setOutTradeNo(out_trade_no);//必填,商户订单号
        model.setSubject(subject);//必填,订单名称
        model.setTotalAmount(total_amount);//必填,付款金额
        model.setBody(body);//选填,商品描述
        model.setProductCode("FAST_INSTANT_TRADE_PAY");//必填,电脑支付FAST_INSTANT_TRADE_PAY,手机支付QUICK_WAP_WAY
        //model.setTimeoutExpress(timeout_express);//选填,增加自定义超时时间参数timeout_express
        alipayRequest.setBizModel(model);

        //请求
        try {
            //把支付信息加密好(私钥),向支付宝后端申请支付,后端用公钥解开信息,生成带有二维码的连接返回给用户,要求用户按链接跳转
            String result = alipayClient.pageExecute(alipayRequest).getBody();
            return result;
        } catch (AlipayApiException e) {
            throw new AlipayRuntimeException("支付宝支付失败", e);
        }

    }
}
```

### 7.4.3API实现

```java
//发起支付,等待支付宝返回支付页面
@RequestMapping(value = "/paydo", method = RequestMethod.POST)
    public void payDo(HttpServletRequest request, HttpServletResponse response,float money) throws Exception {
 //        System.out.println("测试支付");
        Member m = (Member) request.getSession().getAttribute("m");
        response.setContentType("text/html; charset=utf-8");//千万不要忘了设编码,否则密钥报错!!!!!!
        PrintWriter out = response.getWriter();    //输出流

        String out_trade_no = new SimpleDateFormat("yyyyMMddHHmmss").format(new Date()) + "_" + m.getId();//订单号
        String total_amount = money + "";                 //支付金额
        String subject = m.getNickName() + "充值";        //订单名称
        String body = "手机充值";                       //商品描述


        out.print(AlipayUtil.pay(out_trade_no, total_amount, subject, body));
    }
  //异步通知
    @RequestMapping(value = "/pay_notify",method = RequestMethod.POST)
    public void notifyUrl(HttpServletResponse response,HttpServletRequest request) throws IOException, AlipayApiException {
        System.out.println("异步通知");
        PrintWriter out  = response.getWriter();
        request.setCharacterEncoding("utf-8");//乱码解决，这段代码在出现乱码时使用
        //获取支付宝POST过来反馈信息
        Map<String,String> params = new HashMap<String,String>();
        Map<String,String[]> requestParams = request.getParameterMap();
        for(String str :requestParams.keySet()){
            String name = str;
            String[] values = (String[]) requestParams.get(name);
            String valueStr = "";
            for (int i = 0; i < values.length; i++) {
                valueStr = (i == values.length - 1) ? valueStr + values[i]
                        : valueStr + values[i] + ",";
            }
            params.put(name, valueStr);
        }

        boolean signVerified = AlipaySignature.rsaCheckV1(params, AlipayConfig.alipay_public_key, AlipayConfig.charset, AlipayConfig.sign_type); //调用SDK验证签名

        if(!signVerified) {
            System.out.println("验签失败");
            out.print("fail");
            return;
        }

        //商户订单号,之前生成的带用户ID的订单号
        String out_trade_no = params.get("out_trade_no");
        //支付宝交易号
        String trade_no = params.get("trade_no");
        //付款金额
        String total_amount = params.get("total_amount");
        //交易状态
        String trade_status = new String(request.getParameter("trade_status").getBytes("ISO-8859-1"),"UTF-8");

        if(trade_status.equals("TRADE_FINISHED")){
            /*此处可自由发挥*/
            //判断该笔订单是否在商户网站中已经做过处理
            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
            //如果有做过处理，不执行商户的业务程序
            //注意：
            //退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知
        }else if (trade_status.equals("TRADE_SUCCESS")){
            //判断该笔订单是否在商户网站中已经做过处理
            //如果没有做过处理，根据订单号（out_trade_no在商户网站的订单系统中查到该笔订单的详细，并执行商户               的业务程序
            //如果有做过处理，不执行商户的业务程序


            //增加用户在数据库余额
            String[] ss = out_trade_no.split("_");
            int mid = Integer.parseInt(ss[1]);
            Member m = memberService.findOne(mid);
            m.setScore(m.getScore() + (int)Double.parseDouble(total_amount));
            memberService.edit(m);
            //添加充值记录
            service.add(new PayInfo(trade_no,new Date(),"积分充值",m));
            System.out.println("trade_no:"+trade_no+"<br/>out_trade_no:"+out_trade_no+"<br/>total_amount:"+total_amount);

        }

        out.print("success");
    }

    //同步通知
    @RequestMapping(value = "/pay_return",method = RequestMethod.GET)
    public String returnUrl(HttpServletRequest request) throws UnsupportedEncodingException, AlipayApiException {
        System.out.println("同步通知");
        request.setCharacterEncoding("utf-8");//乱码解决，这段代码在出现乱码时使用
        //获取支付宝GET过来反馈信息
        Map<String,String> params = new HashMap<String,String>();
        Map<String,String[]> requestParams = request.getParameterMap();
        for(String str :requestParams.keySet()){
            String name = str;
            String[] values = (String[]) requestParams.get(name);
            String valueStr = "";
            for (int i = 0; i < values.length; i++) {
                valueStr = (i == values.length - 1) ? valueStr + values[i]
                        : valueStr + values[i] + ",";
            }
            params.put(name, valueStr);
        }

        boolean signVerified = AlipaySignature.rsaCheckV1(params, AlipayConfig.alipay_public_key, AlipayConfig.charset, AlipayConfig.sign_type); //调用SDK验证签名

        if(signVerified) {
            System.out.println("验签成功-跳转到成功后页面");
            //跳转至支付成功后的页面,
            return "redirect:payment";
        }else {
            System.out.println("验签失败-跳转到充值页面让用户重新充值");
            return "redirect:addmoney";
        }

        //打印请求中的字段
        for (String str:params.keySet()) {
            System.out.println(str +":"+ params.get(str));
        }
    }

```

### 7.4.4前端页面

```html
<form action="${pageContext.request.contextPath}/paydo" method="POST">
   充值金额:<input type="text" name="money" />
<br/>
<input type="submit"  value="充值"/>
</form>
```

# 8.数据表设计

```shell
# 第三方支付有支付宝和微信
设计的时候按统一的设计，不要区分具体的支付通道.设计一张订单表，一张支付记录表

# 订单会出现未支付情况
订单会有未支付的情况，需要设计过期时间。 一个主订单可能存在一到多个子订单表，这个需要根据业务来决定。 一个主订单对应一笔或多笔支付记录/退款记录。

# 混合支付存在情况
存在这种情况，假设用户选择微信支付，实际支付成功了，但是因为网络原因，用户退回去，重新选了支付宝再作了一次支付也成功了，这样用户就支付了两次。这个涉及到自动退款的问题。所以在支付完成并收到异步通知后，检查数据库中的表是否已经支付完成，因为本来就要查询这个订单数据并进行更新，如果当更新时发现已经被更新了就需要退款。

# 支付回调日志表
还有就是需要一个支付回调的日志表，或者说调用支付的日志表，包括回调的日志。这个日志表需要保存一定时间，过了后可以删除。可以暂定半年左右嘛，到时候看具体数据量，以及对性能影响大不大。
```

![1574236458461](image\1574236458461.png)

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for payment_journal
-- ----------------------------
DROP TABLE IF EXISTS `payment_journal`;
CREATE TABLE `payment_journal`  (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '支付订单编号,out_trade_no',
  `amount` int(11) DEFAULT NULL COMMENT '支付金额',
  `title` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '标题',
  `trade_no` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '第三方平台的交易号',
  `pay_type` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '支付类型,支付宝支付或微信支付',
  `pay_state` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '支付状态,未支付、支付成功(同步)、支付成功(回调)、支付失败、已过期',
  `return_json` varchar(1000) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '第三方回调响应的json字符串',
  `create_time` datetime(0) DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime(0) DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP(0) COMMENT '修改时间,即回调时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '第三方支付日志表' ROW_FORMAT = Dynamic;

SET FOREIGN_KEY_CHECKS = 1;
```

# 9.用户提现

## 9.1 支付宝

```shell
# 接口文档网址
https://b.alipay.com/signing/productDetailV2.htm?productId=I1012000291000001000
# 接口使用文档地址
https://docs.open.alipay.com/api_28/alipay.fund.trans.uni.transfer/
# 说明
商家只需输入另一个正确的支付宝账号，即可将资金从本人的支付宝账户转账至另一个支付宝账户
# 额度
1. 单笔限额：转账给个人支付宝账户，单笔最高 5 万元；转账给企业支付宝账户，单笔最高 10 万元；
2. 日限额：初始额度为 200 万元，即每日最高可转200万元；
3. 月限额：初始额度为 3100 万元，即每月最高可转3100万元；
4. 以上限额支付宝会根据实际转账资金情况进行调整，具体以实际限额为准。
# 费率
'免费'
# 申请条件
仅支持注册满90天，且已实名认证的企业支付宝账户签约，暂时不支持个体工商户及个人支付宝账户。
```

## 9.1.1 统一转账接口

```shell
alipay.fund.trans.uni.transfer(统一转账接口) ，该接口还支持红包
```

| 参数         | 类型        | 是否必填 | 描述                                         |
| ------------ | ----------- | -------- | -------------------------------------------- |
| out_biz_no   | String      | 必选     | 提现订单编号                                 |
| trans_amount | Price       | 必选     | 订单金额：[0.01,100000000]                   |
| product_code | String      | 必选     | 单笔无密转账固定为：TRANS_ACCOUNT_NO_PWD     |
| order_title  | String      | 可选     | 转账业务的标题，用于在支付宝用户的账单里显示 |
| payee_info   | Participant | 必选     | 收款方信息：                                 |

  payee_info参数

| 参数          | 类型   | 是否必填 | 描述                                                     |
| ------------- | ------ | -------- | -------------------------------------------------------- |
| identity      | String | 必填     | 参与方的唯一标识                                         |
| identity_type | String | 必填     | 参与方的标识类型【下面介绍】                             |
| name          | String | 可选     | 参与方真实姓名，如果非空，将校验收款支付宝账号姓名一致性 |

```shell
参与方的标识类型说明：
1、ALIPAY_USER_ID ：支付宝的会员ID
2、ALIPAY_LOGON_ID：支付宝登录号，支持邮箱和手机号格式
```

## 9.2 微信

```shell
# 接口文档网址
https://pay.weixin.qq.com/wiki/doc/api/tools/mch_pay.php?chapter=14_1

# 说明
企业付款为企业提供付款至用户零钱的能力，支持通过API接口付款，或通过微信支付商户平台（pay.weixin.qq.com）网页操作付款。 
# 额度
1.不支持给非实名用户打款
2.给同一个实名用户付款，单笔单日限额5000/5000元
3.一个商户同一日付款总额限额10万元
'注意：以上规则中的限额5000、10万由于计算规则与风控策略的关系，不是完全精确值，金额仅做参考，请不要依赖此金额做系统处理，应以接口实际返回和查询结果为准，请知晓。'
# 收款用户身份校验
针对付款的目标用户，提供可校验真实姓名的功能
# 付款频次
默认每天最多可向同一个用户付款10次，可以在【商户平台-产品中心-企业付款到零钱-产品设置】进行修改
#　费率　
试用期免费
# 使用条件
1、商户号（或同主体其他非服务商商户号）已入驻90日 
2、截止今日回推30天，商户号（或同主体其他非服务商商户号）连续不间断保持有交易
3、 登录微信支付商户平台-产品中心，开通企业付款。 
'即：必须上线30天产生交易量'

```



# 问题

## 1.符号检查失败

**com.alipay.api.AlipayApiException: sign check fail: check Sign and Data Fail**

```shell
'符号检查失败：检查符号和数据失败'
这里着重说明，报这个错误是因为支付宝公钥（alipay_public_key）使用错误导致的！
很多开发者把自己生成的应用公钥和支付宝公钥容易搞混淆！
从而配置错误导致这个错误，自己生成的是应用公钥和应用私钥！

#报错解决： 
确认使用的支付宝公钥是否正确，不同的环境使用的支付宝公钥不同，
如沙箱环境、线上openapi网关和mapi网关对应的支付宝公钥是不一样的。
```

## 2.APP端获取支付结果

**客户端APP吊起支付宝支付，支付完成后,第三方会调用同步通知和异步通知。如果现在同步通知和异步通知都是后端接口，因为不是又客户端调用而是由第三方调用，那么在没有第三方支持下如何实现提醒客户端已经支付完成？**

```shell
#轮询的方式
设定一个时间，每几秒轮询一次服务端是否支付完成
#socket的方式
后端收到通知后直接推送给前端
#第三方提供获取支付结果的方式
`调用 pay 方法支付后，将通过2种途径获得支付结果：`
'同步返回（客户端APP可以直接拿到返回的结果）：'
商户应用客户端通过当前调用支付的Activity的Handler对象，通过它的回调函数获取支付结果。（可参考 alipay_demo 实现）
代码示例：
private Handler mHandler = new Handler() {
		public void handleMessage(Message msg) {
			Result result = new Result((String) msg.obj);
			Toast.makeText(DemoActivity.this, result.getResult(),
						Toast.LENGTH_LONG).show();
	};
};
'异步通知(数据安全性更高，一般直接写后端服务器接口地址，进行库存、订单状态的改变)'
商户需要提供一个 http 协议的接口，包含在请求支付的入参中，其 key 对应 notify_url。支付宝服务器在支付完成后，会以 POST 方式调用 notify_url 传输数据。
```



